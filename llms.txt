# gocode-check

> Biblioteca Go para validação end-to-end de programas G-code através de interpretação lógica e análise semântica.

## Instalação

```bash
go get github.com/eduardotorresdev/gocode-check
```

## Uso Rápido

### CLI

```bash
# Executar com UI de visualização
gocodecheck --ui examples/basic_holes/main_test.go

# Executar testes headless
go test ./examples/...

# Atualizar snapshots
go test ./examples/... -update

# Ver eventos detalhados
gocodecheck --events examples/complete_part/main_test.go
```

### Como Biblioteca

> **Versão da API:** exemplos abaixo válidos para gocode-check v1.0.1+

```go
package main

import (
    "github.com/eduardotorresdev/gocode-check/pkg/assert"
    "github.com/eduardotorresdev/gocode-check/pkg/interpreter"
    "github.com/eduardotorresdev/gocode-check/pkg/machining"
    "github.com/eduardotorresdev/gocode-check/pkg/parser"
)

func TestFuros(t *testing.T) {
    gcode := `
        G90 G21
        G00 Z5.0
        G00 X10 Y10
        G01 Z-5.0 F100
        G00 Z5.0
    `
    
    // Parse
    instructions, err := parser.ParseFile(gcode)
    if err != nil {
        t.Fatal(err)
    }
    
    // Interpret
    trace, err := interpreter.InterpretGCode(instructions)
    if err != nil {
        t.Fatal(err)
    }
    
    // Analyze
    analyzer := machining.NewDefaultAnalyzer()
    model, warnings := analyzer.Analyze(trace)
    _ = warnings
    model = model.WithStock(100, 100, 10).WithEndMill(1, 6.0, 25.0)
    
    // Assert
    result := assert.Expect(trace, model).
        HasHole(10, 10).
        WithDepth(5.0)
    if result.Failed() {
        t.Error(result.Error())
    }
}
```

## Principais Componentes

### 1. Parser (`pkg/parser`)
Converte G-code em instruções estruturadas.

```go
instructions, err := parser.ParseFile(gcode)
```

### 2. Interpreter (`pkg/interpreter`)
Simula o comportamento lógico da CNC, gerando eventos de estado.

```go
trace, err := interpreter.InterpretGCode(instructions)
```

### 3. Machining Model (`pkg/machining`)
Analisa eventos e identifica operações de usinagem (furos, ranhuras, contornos).

```go
analyzer := machining.NewDefaultAnalyzer()
model, warnings := analyzer.Analyze(trace)
_ = warnings

model = model.
    WithStock(width, height, depth).
    WithTool(toolNumber, diameter, fluteLength, toolType)
```

**Tipos de Ferramentas:**
- `machining.ToolTypeEndMill` - Fresa de topo (ponta plana)
- `machining.ToolTypeBallNose` - Fresa esférica (ponta arredondada)

### 4. Assertions (`pkg/assert`)
API fluente para validações de usinagem.

```go
result := assert.Expect(trace, model)

// Validar furos
result.HasHoleCount(3)
result.HasHole(10, 10).WithDepth(10.0)
result.HasHole(10, 10).IsBlindHole()

// Validar ranhuras
result.HasSlotCount(2)
result.HasSlot(0, 0, 50, 0)

// Validar contornos
result.HasContourCount(1)
result.HasContour().IsClosed()
```

### 5. Snapshots (`pkg/snapshot`)
Sistema de snapshots determinísticos para testes.

```go
config := snapshot.DefaultConfig()
if snapshot.ShouldUpdate() {
    _ = snapshot.Save(model, "my_test", config)
} else {
    result, err := snapshot.Compare(model, "my_test", config)
    if err != nil {
        t.Fatal(err)
    }
    if !result.Match {
        t.Fatalf(result.Diff)
    }
}
```

### 6. UI Visualization (`pkg/ui`)
Interface web 3D para debug visual (opcional).

```go
// Programaticamente
cleanup := ui.Enable(ui.DefaultConfig().WithAutoOpen(true))
defer cleanup()

// Ou via CLI
// gocodecheck --ui examples/basic_holes/main_test.go
```

## Estrutura de Stock/Workpiece

O workpiece representa a peça bruta sendo usinada:

```go
model := machining.NewMachiningModel().
    WithStock(100, 100, 10) // width, height, depth

// Posicionar a peça (canto mínimo) se necessário
model = model.WithStockAt(100, 100, 10, 0, 0, -10)
```

**Convenção de coordenadas:**
- **Z=0**: Topo da peça (superfície)
- **Z negativo**: Dentro da peça (cortando)
- **Position.Z**: Base da peça (底部)

**Métodos úteis:**
```go
stock.TopZ()            // Retorna Z=0 (topo)
stock.BottomZ()         // Retorna Position.Z (base)
stock.Contains(x, y, z) // Verifica se ponto está dentro
stock.IsPassThrough(depth) // Verifica se furo atravessa
```

## Estrutura de Ferramentas

Configure ferramentas específicas por número:

```go
model := machining.NewMachiningModel().
    WithTool(1, 6.0, 25.0, machining.ToolTypeEndMill).     // T1: Fresa 6mm
    WithTool(2, 10.0, 30.0, machining.ToolTypeEndMill).    // T2: Fresa 10mm
    WithTool(3, 3.0, 20.0, machining.ToolTypeBallNose).    // T3: Esférica 3mm
```

**Atalhos:**
```go
model.WithEndMill(1, 6.0, 25.0)    // EndMill
model.WithBallNose(2, 3.0, 20.0)   // BallNose
```

**Fallback padrão:** Se nenhuma ferramenta for configurada, usa EndMill 6mm.

## Padrões de Uso

### 1. Teste Unitário Simples

```go
func TestSimpleDrill(t *testing.T) {
    gcode := `G90 G21
              G00 X10 Y10 Z5
              G01 Z-10 F100
              G00 Z5`
    
    instructions, err := parser.ParseFile(gcode)
    if err != nil {
        t.Fatal(err)
    }
    
    trace, err := interpreter.InterpretGCode(instructions)
    if err != nil {
        t.Fatal(err)
    }
    
    model, _ := machining.Analyze(trace)
    model = model.WithStock(100, 100, 20)
    
    result := assert.Expect(trace, model).
        HasHoleCount(1).
        HasHole(10, 10).
        WithDepth(10.0)
    if result.Failed() {
        t.Error(result.Error())
    }
}
```

### 2. Teste com Múltiplas Ferramentas

```go
func TestMultiTool(t *testing.T) {
    gcode := `G90 G21
              T1 M06    ; Fresa 6mm
              G00 X10 Y10
              G01 Z-5 F100
              G00 Z5
              T2 M06    ; Fresa 10mm
              G00 X20 Y20
              G01 Z-8 F100
              G00 Z5`
    
    trace, err := interpreter.ParseAndInterpret(gcode)
    if err != nil {
        t.Fatal(err)
    }
    
    model, _ := machining.Analyze(trace)
    model = model.
        WithStock(100, 100, 10).
        WithEndMill(1, 6.0, 25.0).
        WithEndMill(2, 10.0, 30.0)
    
    result := assert.Expect(trace, model).HasHoleCount(2)
    if result.Failed() {
        t.Error(result.Error())
    }
    // Primeiro furo com T1 (6mm)
    _ = assert.Expect(trace, model).HasHole(10, 10).WithDepth(5.0)
    // Segundo furo com T2 (10mm)
    _ = assert.Expect(trace, model).HasHole(20, 20).WithDepth(8.0)
}
```

### 3. Teste com Snapshot

```go
func TestComplexPart(t *testing.T) {
    gcode := readGCodeFile("part.nc")
    
    // ... parse, interpret, analyze

    snapshot.AssertMatchesSnapshot(t, model, "complex-part")
}
```

### 4. Debug com UI

```go
func TestWithUI(t *testing.T) {
    // ... parse, interpret, analyze
    
    // Visualizar no navegador (opcional)
    cleanup := ui.Enable(ui.DefaultConfig().WithAutoOpen(true))
    defer cleanup()
    
    // Ou via CLI:
    // gocodecheck --ui examples/basic_holes/main_test.go
}
```

## CLI - gocodecheck

### Comandos

```bash
# Executar com UI de visualização 3D
gocodecheck --ui <test_file.go>

# Executar e mostrar eventos detalhados
gocodecheck --events <test_file.go>

# Executar teste headless (padrão)
gocodecheck <test_file.go>

# Atualizar snapshots
go test ./examples/... -update
```

### Flags

- `--ui` - Abre interface web 3D para visualização (porta 4000)
- `--events` - Mostra eventos de interpretação detalhados
- `--port=<num>` - Define porta da UI (padrão: 4000)
- `--config=<file>` - Arquivo de configuração customizado

## Arquitetura

```
┌─────────────┐
│   G-Code    │
└──────┬──────┘
       │ parse
       ▼
┌─────────────┐
│Instructions │
└──────┬──────┘
       │ interpret
       ▼
┌─────────────┐
│   Events    │
└──────┬──────┘
       │ analyze
       ▼
┌─────────────┐
│   Model     │ ◄──── Assert
└──────┬──────┘       (validações)
       │
       ├─────► Snapshot (testes)
       │
       └─────► UI (visual debug)
```

## Integração CI/CD

### GitHub Actions

```yaml
name: G-Code Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      
      - name: Run G-Code Tests
        run: go test ./examples/...
      
      - name: Check Snapshots
        run: |
          go test ./examples/... -update
          git diff --exit-code snapshots/
```

## Exemplos Completos

Veja os exemplos em `/examples`:

- `basic_holes/` - Furos simples
- `slots_and_contours/` - Ranhuras e contornos
- `complete_part/` - Peça complexa com múltiplas operações

## Links Úteis

- **Documentação Completa**: [docs/USAGE_GUIDE.md](docs/USAGE_GUIDE.md)
- **Roadmap**: [ROADMAP.md](ROADMAP.md)
- **Repositório**: https://github.com/eduardotorresdev/gocode-check
- **Issues**: https://github.com/eduardotorresdev/gocode-check/issues

## Licença

MIT License - veja [LICENSE](LICENSE) para detalhes.
